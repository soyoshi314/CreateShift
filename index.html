<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シフト入力補助アプリ</title>
    <style>
        /* 基本的なスタイル */
        html { scroll-behavior: smooth; }
        body {
            font-family: sans-serif; padding: 20px;
            line-height: 1.8; margin-bottom: 100px;
        }
        .container {
            max-width: 700px; margin: 0 auto; border: 1px solid #ccc;
            padding: 25px; border-radius: 8px;
        }
        .input-group { margin-bottom: 20px; }
        .input-group label { font-weight: bold; margin-right: 10px; }
        #mainTextBox {
            padding: 8px; width: 200px; border: 1px solid #ccc; border-radius: 4px;
        }
        .shift-block { margin-top: 25px; }
        .block-title { font-size: 1.2em; font-weight: bold; }
        .shift-line { display: flex; align-items: center; flex-wrap: wrap; }
        .date-entry {
            cursor: pointer; padding: 2px 5px; border-radius: 3px;
            transition: background-color 0.2s;
        }
        .date-entry.selected { background-color: #fffacd; }
        .assignee { color: #d9534f; font-weight: bold; margin: 0 5px; }
        .page-title { text-align: center; margin-bottom: 25px; }
        .section-title {
            font-size: 1.5em; margin-top: 40px; padding-bottom: 5px;
            border-bottom: 2px solid #0056b3;
        }
        .toc {
            margin-bottom: 25px; padding: 15px; background-color: #f8f9fa;
            border: 1px solid #dee2e6; border-radius: 5px;
        }
        .toc h3 { margin-top: 0; }
        .toc ul { list-style-type: none; padding-left: 0; margin-bottom: 0; }
        .toc li { margin-bottom: 5px; }
        .toc a { text-decoration: none; color: #0056b3; font-weight: bold; }
        .toc a:hover { text-decoration: underline; }
        .note-red { color: #dc3545; font-weight: bold; }
        .scroll-button-wrapper {
            text-align: right; margin-top: 20px; margin-bottom: 20px;
        }
        .scroll-button {
            display: inline-block; padding: 8px 16px; background-color: #6c757d;
            color: white; text-decoration: none; border-radius: 4px;
            font-size: 0.9em; transition: background-color 0.2s;
        }
        .scroll-button:hover { background-color: #5a6268; }
        .scroll-button + .scroll-button { margin-left: 8px; }
        .secondary-option {
            margin-left: 8px; padding: 2px 5px; border-radius: 3px;
            transition: background-color 0.2s, color 0.2s; cursor: pointer;
        }
        .secondary-option.disabled { color: #aaa; cursor: not-allowed; background-color: transparent; }
        .secondary-option.selected { background-color: #d4edda; color: #155724; }
        .appended-text { color: #155724; font-weight: bold; margin-left: 8px; }
        .button-container { text-align: center; margin-top: 30px; }
        #sendButton, #resetButton {
            padding: 12px 25px; font-size: 1.1em; cursor: pointer;
            color: white; border: none;
            border-radius: 5px; transition: background-color 0.2s;
        }
        /* 送信ボタンの色を緑に変更 */
        #sendButton { background-color: #28a745; margin-right: 10px; }
        #sendButton:hover { background-color: #218838; }
        #sendButton:disabled { background-color: #96d3a4; cursor: not-allowed;}

        #resetButton { background-color: #6c757d; }
        #resetButton:hover { background-color: #5a6268; }
        
        #notification {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%); background-color: #28a745;
            color: white; padding: 12px 22px; border-radius: 5px;
            z-index: 1000; opacity: 0;
            transition: opacity 0.5s ease-in-out; pointer-events: none;
        }
        #notification.show { opacity: 1; }
        #notification.error { background-color: #dc3545; }
    </style>
</head>
<body>

<div class="container">
    <h1 class="page-title">25年9月シフト</h1>
    <div class="input-group">
        <label for="mainTextBox">マジシャン名（最初に入力してください）</label>
        <input type="text" id="mainTextBox" placeholder="ここに名前を入力">
    </div>

    <p class="note-red" style="margin-top: -10px; margin-bottom: 20px;">
        ・すべてのシフト入力が完了したら、ページ一番下の「スプレッドシートに送信」ボタンを押し、内容を送信ください。<br>
        ・シフトに関してコメントがある場合は、〇〇の部屋で別途送信ください。
    </p>

    <div class="toc" id="toc-anchor">
        <h3>目次</h3>
        <ul>
            <li><a href="#section-1">１．都心ブロック①新宿周辺</a></li>
            <li><a href="#section-2">２．都心ブロック②その他東京</a></li>
            <li><a href="#section-3">３．立川町田ブロック</a></li>
            <li><a href="#section-4">４．千葉埼玉ホームブロック</a></li>
        </ul>
    </div>
    <hr>
    
    <div id="shift-content">
        <h2 class="section-title" id="section-1">１．都心ブロック①新宿周辺</h2>
        <div class="shift-block">
            <p><span class="block-title">【新宿】</span><br>◎沖縄料理一(いち)新宿店<br>◎築地日本海新宿西口店<br>水、金、土、祝、祝前</p>
            <div class="shift-line"><span class="date-entry">3水</span>｜<span class="assignee"></span></div><div class="shift-line"><span class="date-entry">5金</span>｜<span class="assignee"></span></div><div class="shift-line"><span class="date-entry">6土</span>｜<span class="assignee"></span></div><div class="shift-line"><span class="date-entry">10水</span>｜<span class="assignee"></span></div><div class="shift-line"><span class="date-entry">12金</span>｜<span class="assignee"></span></div><div class="shift-line"><span class="date-entry">13土</span>｜<span class="assignee"></span></div><div class="shift-line"><span class="date-entry">14日祝前</span>｜<span class="assignee"></span></div><div class="shift-line"><span class="date-entry">15月祝</span>｜<span class="assignee"></span></div><div class="shift-line"><span class="date-entry">17水</span>｜<span class="assignee"></span></div><div class="shift-line"><span class="date-entry">19金</span>｜<span class="assignee"></span></div><div class="shift-line"><span class="date-entry">20土</span>｜<span class="assignee"></span></div><div class="shift-line"><span class="date-entry">22月祝前</span>｜<span class="assignee"></span></div><div class="shift-line"><span class="date-entry">23火祝</span>｜<span class="assignee"></span></div><div class="shift-line"><span class="date-entry">24水</span>｜<span class="assignee"></span></div><div class="shift-line"><span class="date-entry">26金</span>｜<span class="assignee"></span></div><div class="shift-line"><span class="date-entry">27土</span>｜<span class="assignee"></span></div>
        </div>
        
        <div class="shift-block">
            <p><span class="block-title">【トニーローマ】</span><br>◎トニーローマ三番町店<br>水、金、土、日、祝、祝前</p>
            <div class="shift-line"><span class="date-entry">1水</span>｜<span class="assignee"></span></div>
            <div class="shift-line"><span class="date-entry">5日</span><span class="secondary-option disabled">門前仲町も希望</span>｜<span class="assignee"></span><span class="appended-text"></span></div>
            <div class="shift-line"><span class="date-entry">6土</span><span class="secondary-option disabled">門前仲町も希望</span>｜<span class="assignee"></span><span class="appended-text"></span></div>
            <div class="shift-line"><span class="date-entry">7日</span>｜<span class="assignee"></span></div>
            <div class="shift-line"><span class="date-entry">10水</span>｜<span class="assignee"></span></div>
            <div class="shift-line"><span class="date-entry">12金</span><span class="secondary-option disabled">門前仲町も希望</span>｜<span class="assignee"></span><span class="appended-text"></span></div>
            <div class="shift-line"><span class="date-entry">13土</span><span class="secondary-option disabled">門前仲町も希望</span>｜<span class="assignee"></span><span class="appended-text"></span></div>
            <div class="shift-line"><span class="date-entry">14日祝前</span><span class="secondary-option disabled">門前仲町も希望</span>｜<span class="assignee"></span><span class="appended-text"></span></div>
            <div class="shift-line"><span class="date-entry">15月祝</span><span class="secondary-option disabled">門前仲町も希望</span>｜<span class="assignee"></span><span class="appended-text"></span></div>
            <div class="shift-line"><span class="date-entry">17日</span>｜<span class="assignee"></span></div>
            <div class="shift-line"><span class="date-entry">19金</span><span class="secondary-option disabled">門前仲町も希望</span>｜<span class="assignee"></span><span class="appended-text"></span></div>
            <div class="shift-line"><span class="date-entry">20土</span><span class="secondary-option disabled">門前仲町も希望</span>｜<span class="assignee"></span><span class="appended-text"></span></div>
            <div class="shift-line"><span class="date-entry">21日</span>｜<span class="assignee"></span></div>
            <div class="shift-line"><span class="date-entry">22月祝前</span><span class="secondary-option disabled">門前仲町も希望</span>｜<span class="assignee"></span><span class="appended-text"></span></div>
            <div class="shift-line"><span class="date-entry">23火祝</span><span class="secondary-option disabled">門前仲町も希望</span>｜<span class="assignee"></span><span class="appended-text"></span></div>
            <div class="shift-line"><span class="date-entry">24水</span>｜<span class="assignee"></span></div>
            <div class="shift-line"><span class="date-entry">26金</span><span class="secondary-option disabled">門前仲町も希望</span>｜<span class="assignee"></span><span class="appended-text"></span></div>
            <div class="shift-line"><span class="date-entry">27土</span><span class="secondary-option disabled">門前仲町も希望</span>｜<span class="assignee"></span><span class="appended-text"></span></div>
            <div class="shift-line"><span class="date-entry">28日</span>｜<span class="assignee"></span></div>
        </div>
        </div>

    <div class="scroll-button-wrapper" style="text-align: center;">
        <a href="#toc-anchor" class="scroll-button">目次に戻る</a>
    </div>

    <div id="page-bottom-anchor"></div>

    <div class="button-container">
        <button id="sendButton">スプレッドシートに送信</button>
        <button id="resetButton">リセット</button>
    </div>

<div id="notification"></div>

<script>
// ▼▼▼【！】ここからJavaScriptの動作が大きく変わります ▼▼▼

// --- ★★★【要設定】ステップ3で取得したURLをここに貼り付け ★★★ ---
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzWZpnw41LAA_zvofpqFDo0anl8HeBf4K9hROBl1wW8MHT7uhVXRcNK6pPHcYuJYs4y8Q/exec';
// -------------------------------------------------------------

const STORAGE_KEY = 'shiftAppData_2025_09';

// --- 初期化処理 ---
document.addEventListener('DOMContentLoaded', function() {
    loadData();

    document.querySelectorAll('.date-entry').forEach(el => {
        el.addEventListener('click', () => {
            toggleSelection(el);
            saveData();
        });
    });

    document.querySelectorAll('.secondary-option').forEach(el => {
        el.addEventListener('click', () => {
            toggleSecondaryOption(el);
            saveData();
        });
    });
    
    document.getElementById('mainTextBox').addEventListener('input', () => {
        updateAllAssigneeNames();
        saveData();
    });

    // ボタンのイベントリスナーを sendButton に変更
    document.getElementById('sendButton').addEventListener('click', sendDataToSheet); 
    document.getElementById('resetButton').addEventListener('click', resetAll); 
});


// --- 新機能：スプレッドシートへのデータ送信 ---
function sendDataToSheet() {
    const sendButton = document.getElementById('sendButton');
    const magicianName = document.getElementById('mainTextBox').value.trim();

    if (magicianName === '') {
        alert('マジシャン名を入力してください。');
        return;
    }

    // 送信するデータを格納する配列
    const payload = [];

    document.querySelectorAll('.shift-block').forEach(block => {
        // 店舗名を取得
        const blockTitleEl = block.querySelector('.block-title');
        if (!blockTitleEl) return;
        const storeName = blockTitleEl.innerText.trim();
        
        // その店舗で選択されているシフトを収集
        block.querySelectorAll('.shift-line').forEach(line => {
            const assigneeSpan = line.querySelector('.assignee');
            if (assigneeSpan && assigneeSpan.innerText.trim() !== '') {
                const dateText = line.querySelector('.date-entry').innerText;
                
                let appendedText = '';
                const appendedEl = line.querySelector('.appended-text');
                if (appendedEl && appendedEl.innerText) {
                    appendedText = ' ' + appendedEl.innerText;
                }
                const valueString = assigneeSpan.innerText + appendedText;

                // 送信データとしてオブジェクトを追加
                payload.push({
                    store: storeName,
                    date: dateText,
                    value: valueString
                });
            }
        });
    });

    if (payload.length === 0) {
        alert('送信するシフトが選択されていません。');
        return;
    }

    if (GAS_WEB_APP_URL === 'ここにウェブアプリのURLを貼り付けてください') {
        alert('HTMLファイル内の「GAS_WEB_APP_URL」が設定されていません。\n設定手順を確認してください。');
        return;
    }

    // ボタンを無効化し、テキストを変更して処理中であることを示す
    sendButton.disabled = true;
    sendButton.textContent = '送信中...';

    // Google Apps ScriptにデータをPOST送信
    fetch(GAS_WEB_APP_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'text/plain;charset=utf-8', // GASのPOSTではこのタイプが一般的
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('スプレッドシートに送信しました', false);
        } else {
            // エラーメッセージがあれば表示
            const errorMessage = data.message || '不明なエラーが発生しました。';
            showNotification(`送信に失敗しました: ${errorMessage}`, true);
        }
    })
    .catch(error => {
        console.error('送信エラー:', error);
        showNotification('送信中にエラーが発生しました。', true);
    })
    .finally(() => {
        // ボタンを元に戻す
        sendButton.disabled = false;
        sendButton.textContent = 'スプレッドシートに送信';
    });
}


// --- 通知機能の修正（エラー表示対応） ---
function showNotification(message, isError = false) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    
    notification.classList.remove('error');
    if (isError) {
        notification.classList.add('error');
    }
    
    notification.classList.add('show');
    setTimeout(() => {
        notification.classList.remove('show');
    }, 4000); // 少し長めに表示
}


// --- 以下、既存の関数（変更なし） ---
function saveData() {
    const data = {
        magicianName: document.getElementById('mainTextBox').value,
        selections: []
    };
    document.querySelectorAll('.shift-line').forEach((line, index) => {
        const dateEntry = line.querySelector('.date-entry');
        if (dateEntry && dateEntry.classList.contains('selected')) {
            const secondaryOptions = [];
            line.querySelectorAll('.secondary-option.selected').forEach(opt => {
                secondaryOptions.push(opt.innerText);
            });
            data.selections.push({
                lineIndex: index,
                options: secondaryOptions
            });
        }
    });
    const now = new Date();
    const expiry = now.getTime() + (10 * 24 * 60 * 60 * 1000);
    const item = { value: data, expiry: expiry };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(item));
}

function loadData() {
    const itemStr = localStorage.getItem(STORAGE_KEY);
    if (!itemStr) return;

    let item;
    try {
        item = JSON.parse(itemStr);
    } catch (e) {
        localStorage.removeItem(STORAGE_KEY);
        return;
    }

    if (typeof item !== 'object' || item === null || !item.expiry || !item.value) {
        localStorage.removeItem(STORAGE_KEY);
        return;
    }
    
    const now = new Date();
    if (now.getTime() > item.expiry) {
        localStorage.removeItem(STORAGE_KEY);
        return;
    }

    const data = item.value;
    const name = data.magicianName || '';
    document.getElementById('mainTextBox').value = name;

    if (Array.isArray(data.selections)) {
        const allLines = document.querySelectorAll('.shift-line');
        data.selections.forEach(sel => {
            if (sel && typeof sel.lineIndex === 'number') {
                const line = allLines[sel.lineIndex];
                if (line) {
                    const dateEntry = line.querySelector('.date-entry');
                    if (dateEntry) {
                        dateEntry.classList.add('selected');
                        line.querySelector('.assignee').textContent = name;
                        
                        const secondaryOpts = line.querySelectorAll('.secondary-option');
                        secondaryOpts.forEach(opt => opt.classList.remove('disabled'));

                        if (sel.options && sel.options.length > 0) {
                            let appendedText = '';
                            secondaryOpts.forEach(opt => {
                                if (sel.options.includes(opt.innerText)) {
                                    opt.classList.add('selected');
                                    appendedText += `（${opt.innerText}） `;
                                }
                            });
                            line.querySelector('.appended-text').textContent = appendedText.trim();
                        }
                    }
                }
            }
        });
    }
}

function resetAll() {
    if (confirm('入力内容をすべてリセットします。よろしいですか？')) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
    }
}

function updateAllAssigneeNames() {
    const newName = document.getElementById('mainTextBox').value;
    document.querySelectorAll('.date-entry.selected').forEach(selectedDate => {
        const assigneeSpan = selectedDate.parentElement.querySelector('.assignee');
        if (assigneeSpan) {
            assigneeSpan.textContent = newName;
        }
    });
}

function toggleSelection(clickedElement) {
    const name = document.getElementById('mainTextBox').value;
    const assigneeSpan = clickedElement.parentElement.querySelector('.assignee');
    const secondaryOptions = clickedElement.parentElement.querySelectorAll('.secondary-option');
    const isCurrentlySelected = clickedElement.classList.contains('selected');

    if (isCurrentlySelected) {
        clickedElement.classList.remove('selected');
        assigneeSpan.textContent = '';
        if (secondaryOptions.length > 0) {
            secondaryOptions.forEach(option => {
                option.classList.remove('selected');
                option.classList.add('disabled');
            });
            const appendedTextSpan = clickedElement.parentElement.querySelector('.appended-text');
            if (appendedTextSpan) appendedTextSpan.textContent = '';
        }
    } else {
        if (name.trim() === '') {
            alert('マジシャン名を入力してください。');
            return;
        }
        clickedElement.classList.add('selected');
        assigneeSpan.textContent = name;
        if (secondaryOptions.length > 0) {
            secondaryOptions.forEach(option => {
                option.classList.remove('disabled');
            });
        }
    }
}

function toggleSecondaryOption(clickedElement) {
    if (clickedElement.classList.contains('disabled')) return;

    const appendedTextSpan = clickedElement.parentElement.querySelector('.appended-text');
    const textToAdd = clickedElement.innerText;
    const formattedText = `（${textToAdd}）`;
    if (clickedElement.classList.contains('selected')) {
        clickedElement.classList.remove('selected');
        appendedTextSpan.textContent = appendedTextSpan.textContent.replace(formattedText, '').trim();
    } else {
        clickedElement.classList.add('selected');
        appendedTextSpan.textContent = (appendedTextSpan.textContent + ' ' + formattedText).trim();
    }
}
</script>
</body>
</html>
