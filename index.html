<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シフト入力アプリ</title>
    <style>
        html { scroll-behavior: smooth; }
        body {
            font-family: sans-serif; padding: 20px;
            line-height: 1.8; margin-bottom: 100px;
        }
        .container {
            max-width: 700px; margin: 0 auto; border: 1px solid #ccc;
            padding: 25px; border-radius: 8px;
        }
        .input-group { margin-bottom: 20px; }
        .input-group label { font-weight: bold; margin-right: 10px; }
        #mainTextBox {
            padding: 8px; width: 200px; border: 1px solid #ccc; border-radius: 4px;
        }
        .shift-block { margin-top: 25px; }
        .block-title { font-size: 1.2em; font-weight: bold; }
        .shift-line { display: flex; align-items: center; flex-wrap: wrap; }
        .date-entry {
            cursor: pointer; padding: 2px 5px; border-radius: 3px;
            transition: background-color 0.2s;
        }
        .date-entry.selected { background-color: #fffacd; }
        .assignee { color: #d9534f; font-weight: bold; margin: 0 5px; }
        .page-title { text-align: center; margin-bottom: 25px; }
        .section-title {
            font-size: 1.5em; margin-top: 40px; padding-bottom: 5px;
            border-bottom: 2px solid #0056b3;
        }
        .toc {
            margin-bottom: 25px; padding: 15px; background-color: #f8f9fa;
            border: 1px solid #dee2e6; border-radius: 5px;
        }
        .toc h3 { margin-top: 0; }
        .toc ul { list-style-type: none; padding-left: 0; margin-bottom: 0; }
        .toc li { margin-bottom: 5px; }
        .toc a { text-decoration: none; color: #0056b3; font-weight: bold; }
        .toc a:hover { text-decoration: underline; }
        .note-red { color: #dc3545; font-weight: bold; }
        .scroll-button-wrapper {
            text-align: right; margin-top: 20px; margin-bottom: 20px;
        }
        .scroll-button {
            display: inline-block; padding: 8px 16px; background-color: #6c757d;
            color: white; text-decoration: none; border-radius: 4px;
            font-size: 0.9em; transition: background-color 0.2s;
        }
        .scroll-button:hover { background-color: #5a6268; }
        .scroll-button + .scroll-button { margin-left: 8px; }
        .secondary-option {
            margin-left: 8px; padding: 2px 5px; border-radius: 3px;
            transition: background-color 0.2s, color 0.2s; cursor: pointer;
        }
        .secondary-option.disabled { color: #aaa; cursor: not-allowed; background-color: transparent; }
        .secondary-option.selected { background-color: #d4edda; color: #155724; }
        .appended-text { color: #155724; font-weight: bold; margin-left: 8px; }
        .button-container { text-align: center; margin-top: 30px; }
        #sendButton, #resetButton {
            padding: 12px 25px; font-size: 1.1em; cursor: pointer;
            color: white; border: none;
            border-radius: 5px; transition: background-color 0.2s;
        }
        #sendButton { background-color: #28a745; margin-right: 10px; }
        #sendButton:hover { background-color: #218838; }
        #sendButton:disabled { background-color: #96d3a4; cursor: not-allowed;}
        #resetButton { background-color: #6c757d; }
        #resetButton:hover { background-color: #5a6268; }
        #notification {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%); background-color: #28a745;
            color: white; padding: 12px 22px; border-radius: 5px;
            z-index: 1000; opacity: 0;
            transition: opacity 0.5s ease-in-out; pointer-events: none;
        }
        #notification.show { opacity: 1; }
        #notification.error { background-color: #dc3545; }
    </style>
</head>
<body>

<div class="container">
    <h1 class="page-title">25年10月シフト</h1>
    <div class="input-group">
        <label for="mainTextBox">マジシャン名（最初に入力してください）</label>
        <input type="text" id="mainTextBox" placeholder="ここに名前を入力">
    </div>

    <p class="note-red" style="margin-top: -10px; margin-bottom: 20px;">
        すべてのシフト入力が完了したら、ページ一番下の「シフト提出」ボタンを押し、<br>「シフト提出が完了しました」と表示されるまでお待ちください(40秒くらいかかる場合もアリ)
    </p>

    <div class="toc" id="toc-anchor">
        </div>
    <hr>
    
    <div id="shift-content">
        </div>

    <div class="scroll-button-wrapper" style="text-align: center;">
        <a href="#toc-anchor" class="scroll-button">目次に戻る</a>
    </div>

    <div id="page-bottom-anchor"></div>

    <div class="button-container">
        <button id="sendButton">シフト提出</button>
        <button id="resetButton">リセット</button>
    </div>

<div id="notification"></div>

<script>
// ▼▼▼【！】ここからJavaScriptを全面的に修正▼▼▼

// --- ★★★【要設定】ステップ3で取得したURLをここに貼り付け ★★★ ---
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwmD-V9LWDQ7edPKsUwC9QWszCzJ-JYGT_vQ-nU6S75VnddpsQBRG91c90ZZymi7rP5yg/exec';
// -------------------------------------------------------------

const STORAGE_KEY = 'shiftAppData_2025_10';

document.addEventListener('DOMContentLoaded', function() {
    loadData();
    document.querySelectorAll('.date-entry').forEach(el => {
        el.addEventListener('click', () => { toggleSelection(el); saveData(); });
    });
    document.querySelectorAll('.secondary-option').forEach(el => {
        el.addEventListener('click', () => { toggleSecondaryOption(el); saveData(); });
    });
    document.getElementById('mainTextBox').addEventListener('input', () => {
        updateAllAssigneeNames();
        saveData();
    });
    document.getElementById('sendButton').addEventListener('click', sendDataToSheet);
    document.getElementById('resetButton').addEventListener('click', resetAll);
});

function sendDataToSheet() {
    if (!confirm('シフト提出します。よろしいですか？')) return;

    const sendButton = document.getElementById('sendButton');
    if (document.getElementById('mainTextBox').value.trim() === '') {
        alert('マジシャン名を入力してください。');
        return;
    }
    const payload = [];
    document.querySelectorAll('.shift-block').forEach(block => {
        const blockTitleEl = block.querySelector('.block-title');
        if (!blockTitleEl) return;
        const storeName = blockTitleEl.innerText.trim();
        block.querySelectorAll('.shift-line').forEach(line => {
            const assigneeSpan = line.querySelector('.assignee');
            if (assigneeSpan && assigneeSpan.innerText.trim() !== '') {
                const dateText = line.querySelector('.date-entry').innerText;
                let appendedText = '';
                const appendedEl = line.querySelector('.appended-text');
                if (appendedEl && appendedEl.innerText) {
                    appendedText = ' ' + appendedEl.innerText;
                }
                const valueString = assigneeSpan.innerText + appendedText;
                payload.push({ store: storeName, date: dateText, value: valueString });
            }
        });
    });
    if (payload.length === 0) {
        alert('送信するシフトが選択されていません。');
        return;
    }
    if (GAS_WEB_APP_URL.includes('ここに')) {
        alert('HTMLファイル内の「GAS_WEB_APP_URL」が設定されていません。\n設定手順を確認してください。');
        return;
    }

    sendButton.disabled = true;
    sendButton.textContent = '送信中...';

    fetch(GAS_WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // ▼▼▼【！】ここから修正・追加▼▼▼
            // 1. 提出済み状態にして保存
            saveData(true);

            // 2. 提出内容をクリップボードにコピー
            const textToCopy = formatPayloadForCopy(payload);
            navigator.clipboard.writeText(textToCopy).then(() => {
                // 3. 通知メッセージを変更して表示
                showNotification('シフト内容をコピーしました。', false);
            }).catch(err => {
                // コピーに失敗しても提出成功の通知は出す
                console.error('コピーに失敗しました:', err);
                showNotification('提出完了（コピーには失敗）', true);
            });
            // ▲▲▲【！】ここまで修正・追加▲▲▲
        } else {
            showNotification(`送信に失敗しました: ${data.message || '不明なエラー'}`, true);
            sendButton.disabled = false; // 失敗時はボタンを再度有効に
        }
    })
    .catch(error => {
        console.error('送信エラー:', error);
        showNotification('送信中にエラーが発生しました。', true);
        sendButton.disabled = false; // 失敗時はボタンを再度有効に
    })
    .finally(() => {
        // finallyからはボタンの制御を削除（成功時に永続的に無効化するため）
        if (!sendButton.disabled) {
           sendButton.textContent = 'シフト提出';
        }
    });
}

// 提出内容を整形してテキスト化する関数
function formatPayloadForCopy(payload) {
    if (!payload || payload.length === 0) return '';
    
    // 店舗（ブロック）ごとにグループ化
    const grouped = payload.reduce((acc, item) => {
        if (!acc[item.store]) {
            acc[item.store] = [];
        }
        acc[item.store].push(`${item.date}｜${item.value}`);
        return acc;
    }, {});

    let text = '';
    for (const store in grouped) {
        text += `${store}\n`;
        text += grouped[store].join('\n');
        text += '\n\n';
    }
    return text.trim();
}

function showNotification(message, isError = false) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.classList.toggle('error', isError);
    notification.classList.add('show');
    setTimeout(() => { notification.classList.remove('show'); }, 4000);
}

// isSubmittedフラグを受け取れるように修正
function saveData(isSubmitted = false) {
    const data = {
        magicianName: document.getElementById('mainTextBox').value,
        selections: [],
        submitted: isSubmitted // 提出状態を保存
    };
    document.querySelectorAll('.shift-line').forEach((line, index) => {
        const dateEntry = line.querySelector('.date-entry');
        if (dateEntry && dateEntry.classList.contains('selected')) {
            const secondaryOptions = [];
            line.querySelectorAll('.secondary-option.selected').forEach(opt => {
                secondaryOptions.push(opt.innerText);
            });
            data.selections.push({ lineIndex: index, options: secondaryOptions });
        }
    });
    const item = { value: data, expiry: new Date().getTime() + (10 * 24 * 60 * 60 * 1000) };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(item));
}

function loadData() {
    const itemStr = localStorage.getItem(STORAGE_KEY);
    if (!itemStr) return;
    try {
        const item = JSON.parse(itemStr);
        if (!item || !item.expiry || !item.value || new Date().getTime() > item.expiry) {
            localStorage.removeItem(STORAGE_KEY);
            return;
        }
        const data = item.value;
        const name = data.magicianName || '';
        document.getElementById('mainTextBox').value = name;

        // ▼▼▼【！】提出済みならボタンを無効化▼▼▼
        if (data.submitted) {
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            sendButton.textContent = '提出済み';
        }

        if (Array.isArray(data.selections)) {
            const allLines = document.querySelectorAll('.shift-line');
            data.selections.forEach(sel => {
                if (sel && typeof sel.lineIndex === 'number') {
                    const line = allLines[sel.lineIndex];
                    if (line) {
                        const dateEntry = line.querySelector('.date-entry');
                        if (dateEntry) {
                            dateEntry.classList.add('selected');
                            line.querySelector('.assignee').textContent = name;
                            const secondaryOpts = line.querySelectorAll('.secondary-option');
                            secondaryOpts.forEach(opt => opt.classList.remove('disabled'));
                            if (sel.options && sel.options.length > 0) {
                                let appendedText = '';
                                secondaryOpts.forEach(opt => {
                                    if (sel.options.includes(opt.innerText)) {
                                        opt.classList.add('selected');
                                        appendedText += `（${opt.innerText}） `;
                                    }
                                });
                                line.querySelector('.appended-text').textContent = appendedText.trim();
                            }
                        }
                    }
                }
            });
        }
    } catch (e) {
        localStorage.removeItem(STORAGE_KEY);
    }
}

function resetAll() {
    if (confirm('入力内容をすべてリセットします。よろしいですか？')) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
    }
}

function updateAllAssigneeNames() {
    const newName = document.getElementById('mainTextBox').value;
    document.querySelectorAll('.date-entry.selected').forEach(selectedDate => {
        const assigneeSpan = selectedDate.parentElement.querySelector('.assignee');
        if (assigneeSpan) {
            assigneeSpan.textContent = newName;
        }
    });
    // 内容が変更されたので、ボタンを再度有効化
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = false;
    sendButton.textContent = 'シフト提出';
}

function toggleSelection(clickedElement) {
    // ... (既存のロジックは変更なし) ...
    // 内容が変更されたので、ボタンを再度有効化
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = false;
    sendButton.textContent = 'シフト提出';
}

function toggleSecondaryOption(clickedElement) {
    // ... (既存のロジックは変更なし) ...
    // 内容が変更されたので、ボタンを再度有効化
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = false;
    sendButton.textContent = 'シフト提出';
}

// 既存の関数toggleSelectionとtoggleSecondaryOption、updateAllAssigneeNamesの最後に
// 以下のコードを追加して、変更があったらボタンを有効に戻すようにします。
// （上記のコードでは既に関数内に直接追記しています）
['input', 'click'].forEach(eventType => {
    document.getElementById('shift-content').addEventListener(eventType, () => {
        const sendButton = document.getElementById('sendButton');
        if (sendButton.disabled) {
            sendButton.disabled = false;
            sendButton.textContent = 'シフト提出';
            saveData(false); // 未提出状態として保存
        }
    });
    document.getElementById('mainTextBox').addEventListener(eventType, () => {
         const sendButton = document.getElementById('sendButton');
        if (sendButton.disabled) {
            sendButton.disabled = false;
            sendButton.textContent = 'シフト提出';
            saveData(false); // 未提出状態として保存
        }
    });
});
</script>
</body>
</html>
